---
title: "Blank Correction Methods Comparison"
author: "Brett Longworth"
date: "2/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Investigate the impact of changes to the blank correction methods.

Looking at:

1. Mass balance correction for all samples
2. Large blank average from wheel instead of long-term average for small samples
3. Total_mass instead of target_mass
4. Subtracting mass of blank from total or target mass to get mass of unknown
5. New vs old parameters for mass balance correction

Use data from snics_results, which has norm_fm as the uncorrected Fm, and all
parameters necessary for blank correction.

Use blank correction functions from SNICSer in amstools.

## Load libraries

```{r}
library(amstools)
library(tidyverse)
library(odbc)
library(glue)
```

# Get data

```{r}
# get data from snics_results
data <- getWheel("CFAMS020620")

# get corresponding info from dc13
con <- conNOSAMS()
sql <- glue_sql("SELECT * FROM dc13 WHERE tp_num IN ({tp*})",
                  tp = data$tp_num,
                  .con = con)
query <- dbSendQuery(con, sql)
dc13 <- dbFetch(query)
data <- left_join(data, dc13, by = "tp_num") 

data <- data %>% mutate(total_ug_co2 = total_umols_co2 * 12.015,
                graphite_ug_co2 = graphite_umols_co2 * 12.015,
                unknown_ug_co2 = graphite_ug_co2 - mass_cont,
                measmasserr = ifelse(is.na(sig_tot_umols), graphite_ug_co2 * .1, sig_tot_umols))
```

# Apply MBC to all samples

## Add MBC and check against small samples

```{r}

# Do MBC
data <- data %>%
        mutate(fmMBcor = pmap(list(.$fm_corr, .$fm_cont, 
                                   .$graphite_ug_co2, .$mass_cont), 
                              doMBC),
               fmMBcorerr = pmap(list(.$fm_corr, .$fm_cont, 
                                      .$graphite_ug_co2, .$mass_cont, 
                                      .$sig_fm_corr, .$fm_cont_err, 
                                      .$measmasserr, .$mass_cont_err), doMBCerr))
               
pmap(list(data$fm_corr, data$fm_blank, data$graphite_ug_co2, data$mass_cont), doMBC)

data %>% 
  select(wheel_pos, fm_corr, sig_fm_corr, fm_mb_corr, sig_fm_mb_corr, fmMBcor, fmMBcorerr) %>%
  View

```

## Look at differences

