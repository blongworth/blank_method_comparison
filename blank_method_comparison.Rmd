---
title: "Blank Correction Methods Comparison"
author: "Brett Longworth"
date: "2/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Investigate the impact of changes to the blank correction methods.

Looking at:

1. Mass balance correction for all samples
2. Large blank average from wheel instead of long-term average for small samples
3. Total_mass instead of target_mass
4. Subtracting mass of blank from total or target mass to get mass of unknown
5. New vs old parameters for mass balance correction

Use data from snics_results, which has norm_fm as the uncorrected Fm, and all
parameters necessary for blank correction.

Use blank correction functions from SNICSer in amstools.

## Load libraries

```{r}
library(amstools)
library(tidyverse)
library(odbc)
library(glue)
library(here)
library(skimr)
```

# Get data

```{r}


con <- conNOSAMS()
# get info from dc13
getdc13 <- function(tps) {
  sql <- glue_sql("SELECT * FROM dc13 WHERE tp_num IN ({tp*})",
                  tp = tps,
                  .con = con)
  query <- dbSendQuery(con, sql)
  data <- dbFetch(query)
  dbClearResult(query)
  data
}

# get data from snics_results
data <- getWheel("CFAMS020620")
dc13 <- getdc13(data$tp_num)
cf020620 <- data %>%
  left_join(dc13, by = "tp_num") %>% 
  mutate(total_ug_co2 = total_umols_co2 * 12.015,
                graphite_ug_co2 = graphite_umols_co2 * 12.015,
                unknown_ug_co2 = graphite_ug_co2 - mass_cont,
                measmasserr = ifelse(is.na(sig_tot_umols), graphite_ug_co2 * .1, sig_tot_umols))

write_csv(cf020620, here("data/cf020620.csv"))

# also get all qc data, join to dc13 and add fm_corr and error
load(here("data/qcData.rda"))
dc13 <- getdc13(std$tp_num)
sql <- glue_sql("SELECT tp_num, fm_corr, sig_fm_corr FROM snics_results WHERE tp_num IN ({tp*})",
                tp = std$tp_num,
                .con = con)
query <- dbSendQuery(con, sql)
fm <- dbFetch(query)
dbClearResult(query)
std <- std %>%
  ungroup() %>%
  inner_join(fm, by = "tp_num") %>% 
  inner_join(dc13, by = "tp_num") %>% 
  mutate(total_ug_co2 = total_umols_co2 * 12.015,
                graphite_ug_co2 = graphite_umols_co2 * 12.015,
                unknown_ug_co2 = graphite_ug_co2 - mass_cont,
                measmasserr = ifelse(is.na(sig_tot_umols), graphite_ug_co2 * .1, sig_tot_umols))

write_csv(std, here("data/std.csv"))
```

# Apply MBC to all samples

## Add MBC and check against small samples for CFAMS020620

```{r}
# Do MBC
cf020620 <- cf020620  %>%
        mutate(fmMBcor = pmap_dbl(list(.$fm_corr, .$fm_cont, 
                                   .$graphite_ug_co2, .$mass_cont), 
                              doMBC),
               fmMBcorerr = pmap_dbl(list(.$fm_corr, .$fm_cont, 
                                      .$graphite_ug_co2, .$mass_cont, 
                                      .$sig_fm_corr, .$fm_cont_err, 
                                      .$measmasserr, .$mass_cont_err), doMBCerr))

cf020620 %>% 
  select(wheel_pos, fm_corr, sig_fm_corr, fm_mb_corr, sig_fm_mb_corr, fmMBcor, fmMBcorerr) %>%
  View
```

## Look at effect of MBC on all data

```{r}
std <- read_csv(here("data/std.csv"))
std <- std  %>%
  filter(gf_co2_qty > 0,
         lab == "OSG",
         !is.na(graphite_ug_co2),
         !is.na(fm_cont),
         fm_consensus > 0.1,
         abs(sigma) < 10) %>%
  mutate(fmMBcor = pmap_dbl(list(.$fm_corr, .$fm_cont, 
                             .$graphite_ug_co2, .$mass_cont), doMBC),
         fmMBcorerr = pmap_dbl(list(.$fm_corr, .$fm_cont, 
                                .$graphite_ug_co2, .$mass_cont, 
                                .$sig_fm_corr, .$fm_cont_err, 
                                .$measmasserr, .$mass_cont_err), doMBCerr),
         fmMBcorSigma = ifelse(!is.na(fmMBcor), sigma(fmMBcor, fm_consensus, fmMBcorerr), NA),
         fmMBcornormFm = ifelse(!is.na(fmMBcor), normFm(fmMBcor, fm_consensus), NA))
```

# summarize

```{r}

solox <- std %>%
  filter(rec_num == 34148,
         f_modern > 0.9,
         process == "OC") %>%
  select(runtime, system, graphite_ug_co2, f_modern, rep_err, fmMBcor, fmMBcorerr, sigma, fmMBcorSigma)
skim(solox)
solox %>%
  group_by(system) %>%
  summarize_all(list(mean, sd))

solox %>%
  filter(graphite_ug_co2 > 500) %>%
  group_by(system) %>%
  summarize_all(list(mean, sd))
  
ggplot(solox, aes(graphite_ug_co2)) +
  geom_point(aes(y = f_modern, color = "orange")) +
  geom_point(aes(y = fmMBcor, color = "green"))
```


Let's look at whether this works with GS OX-I

