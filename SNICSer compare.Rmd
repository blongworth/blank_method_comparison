---
title: "SNICSer method comparison"
output: html_notebook
---

Compare data from wheels analysed with the production version of SNICSer with data from the new blank methods used by the test version 2.90.

First pass: USAMS030520 and CFAMS031020.

Load wheels in prod version of snicser
inherit 1st analyst's flags
save analysis to file
load wheel from file in test version
load saved analysis
blank correct
first authorize
```{r}
library(amstools)
library(odbc)
library(glue)
library(tidyverse)
library(here)
```

### Get data


```{r}

con <- conNOSAMS()
dbListFields(con, "snics_results")
getBCWheel <- function(table, wheels) {
  query <- glue_sql("SELECT wheel, wheel_pos, tp_num, norm_method, ss,
                       sample_name, sample_type, num_runs, norm_ratio,
                       fm_corr, sig_fm_corr, lg_blk_fm,
                       fm_mb_corr, sig_fm_mb_corr 
                     FROM {`table`}
                     WHERE wheel in ({wheels*})",
                    table = table,
                    wheels = wheels,
                    .con = con)
  dbGetQuery(con, query) %>%
    mutate(table = table)
}

data <- map_dfr(c("snics_results", "snics_results_test"), getBCWheel, c("USAMS030520", "CFAMS031020"))
write_csv(data, here("data/SNICSer_blank_compare.csv"))
```

### check differences in LBC

Just sanity checking to make sure SNICSer's working and that we're looking at the right data.

Looks like some small differences in fm_corr due to diffs in lg_blk_fm. Some are due to using dc13 for lg_blk_fm for small samples.

```{r}
data %>%
  pivot_wider(c(wheel, wheel_pos, ss, tp_num), names_from = table, values_from = lg_blk_fm) %>%
  mutate(fm_diff = snics_results - snics_results_test) 
```

